// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String
  firstName         String
  lastName          String
  role              String   // veterinarian, nurse, receptionist, shop_staff, student, admin
  permissions       String[] // admin, owner, edit, read
  phoneNumber       String?
  address           String?
  specialization    String?
  licenseNumber     String?
  emergencyContact  String?
  voiceProfileUrl   String?
  isActive          Boolean  @default(true)
  lastLogin         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  appointments      Appointment[]
  schedules         Schedule[]
  generatedInvoices Invoice[]       @relation("GeneratedBy")
  approvedInvoices  Invoice[]       @relation("ApprovedBy")
  auditLogs         AuditLog[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model Schedule {
  id          String  @id @default(uuid())
  userId      String
  dayOfWeek   Int     // 0-6 (Sunday-Saturday)
  startTime   String  // HH:MM format
  endTime     String  // HH:MM format
  isAvailable Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("schedules")
}

// ============================================
// CLIENT & PET MANAGEMENT
// ============================================

model Client {
  id                String   @id @default(uuid())
  firstName         String
  lastName          String
  email             String?
  phonePrimary      String
  phoneSecondary    String?
  addressLine1      String?
  addressLine2      String?
  city              String?
  state             String?
  postalCode        String?
  country           String   @default("Slovakia")
  idNumber          String?
  preferredLanguage String   @default("sk")
  preferredVetId    String?
  referralSource    String?
  marketingConsent  Boolean  @default(false)
  notes             String?
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  pets          Pet[]
  appointments  Appointment[]
  invoices      Invoice[]
  communications ClientCommunication[]
  eshopOrders   EshopOrder[]

  @@index([email])
  @@index([phonePrimary])
  @@map("clients")
}

model Pet {
  id              String    @id @default(uuid())
  clientId        String
  name            String
  species         String
  breed           String?
  dateOfBirth     DateTime?
  gender          String?
  color           String?
  microchipNumber String?
  weight          Float?
  isDeceased      Boolean   @default(false)
  deceasedDate    DateTime?
  allergies       String?
  medicalNotes    String?
  insuranceInfo   String?
  photoUrl        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  client            Client                @relation(fields: [clientId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  vaccinations      Vaccination[]
  diagnoses         Diagnosis[]
  treatments        Treatment[]
  prescriptions     Prescription[]
  surgeries         Surgery[]
  labTests          LabTest[]
  diagnosticImaging DiagnosticImaging[]
  visitNotes        VisitNote[]
  weightHistory     WeightHistory[]
  invoices          Invoice[]

  @@index([clientId])
  @@index([microchipNumber])
  @@map("pets")
}

model WeightHistory {
  id         String   @id @default(uuid())
  petId      String
  weight     Float
  measuredAt DateTime @default(now())
  notes      String?

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("weight_history")
}

// ============================================
// APPOINTMENTS
// ============================================

model Appointment {
  id               String    @id @default(uuid())
  clientId         String
  petId            String
  assignedVetId    String?
  appointmentType  String    // consultation, surgery, vaccination, follow_up, emergency, grooming
  scheduledStart   DateTime
  scheduledEnd     DateTime
  actualStart      DateTime?
  actualEnd        DateTime?
  status           String    @default("scheduled") // scheduled, confirmed, checked_in, in_progress, completed, cancelled, no_show
  roomNumber       String?
  reason           String?
  specialInstructions String?
  reminderSent     Boolean   @default(false)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  client         Client          @relation(fields: [clientId], references: [id])
  pet            Pet             @relation(fields: [petId], references: [id])
  vet            User?           @relation(fields: [assignedVetId], references: [id])
  visitNotes     VisitNote[]
  voiceRecordings VoiceRecording[]
  invoices       Invoice[]

  @@index([clientId])
  @@index([petId])
  @@index([assignedVetId])
  @@index([scheduledStart])
  @@map("appointments")
}

// ============================================
// MEDICAL RECORDS
// ============================================

model VisitNote {
  id               String   @id @default(uuid())
  appointmentId    String
  petId            String
  veterinarianId   String?
  chiefComplaint   String
  history          String?
  physicalExam     Json?
  assessment       String?
  plan             String?
  voiceRecordingUrl String?
  transcription    String?
  aiExtractedData  Json?
  isDraft          Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  pet         Pet         @relation(fields: [petId], references: [id])

  @@index([appointmentId])
  @@index([petId])
  @@map("visit_notes")
}

model Vaccination {
  id              String   @id @default(uuid())
  petId           String
  vaccineName     String
  manufacturer    String?
  lotNumber       String?
  administeredDate DateTime
  expirationDate  DateTime?
  nextDueDate     DateTime?
  administeredBy  String?
  site            String?
  notes           String?
  createdAt       DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([nextDueDate])
  @@map("vaccinations")
}

model Diagnosis {
  id          String   @id @default(uuid())
  petId       String
  diagnosisName String
  diagnosisCode String?
  severity    String?
  diagnosedDate DateTime @default(now())
  notes       String?
  createdAt   DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("diagnoses")
}

model Treatment {
  id            String   @id @default(uuid())
  petId         String
  treatmentType String
  description   String
  startDate     DateTime @default(now())
  endDate       DateTime?
  frequency     String?
  notes         String?
  createdAt     DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("treatments")
}

model Prescription {
  id           String   @id @default(uuid())
  petId        String
  medication   String
  dosage       String
  frequency    String
  duration     String?
  route        String?
  instructions String?
  prescribedDate DateTime @default(now())
  expiryDate   DateTime?
  refills      Int      @default(0)
  notes        String?
  createdAt    DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("prescriptions")
}

model Surgery {
  id            String   @id @default(uuid())
  petId         String
  surgeryType   String
  surgeon       String?
  assistants    String?
  anesthesia    String?
  surgeryDate   DateTime
  duration      Int?
  complications String?
  outcome       String?
  notes         String?
  createdAt     DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("surgeries")
}

model LabTest {
  id          String   @id @default(uuid())
  petId       String
  testType    String
  testDate    DateTime @default(now())
  results     Json?
  interpretation String?
  performedBy String?
  notes       String?
  createdAt   DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("lab_tests")
}

model DiagnosticImaging {
  id          String   @id @default(uuid())
  petId       String
  imagingType String   // xray, ultrasound, mri, ct
  bodyPart    String?
  imageUrl    String?
  findings    String?
  imagedDate  DateTime @default(now())
  radiologist String?
  notes       String?
  createdAt   DateTime @default(now())

  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@map("diagnostic_imaging")
}

// ============================================
// VOICE RECORDINGS
// ============================================

model VoiceRecording {
  id                String   @id @default(uuid())
  appointmentId     String
  roomNumber        String?
  recordingUrl      String
  durationSeconds   Int
  transcription     String?
  speakerDiarization Json?
  aiExtractedData   Json?
  processed         Boolean  @default(false)
  createdAt         DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id])

  @@index([appointmentId])
  @@map("voice_recordings")
}

// ============================================
// INVOICING & PAYMENTS
// ============================================

model Invoice {
  id            String   @id @default(uuid())
  invoiceNumber String   @unique
  clientId      String
  petId         String?
  appointmentId String?
  status        String   @default("draft") // draft, pending_approval, approved, sent, paid, partially_paid, overdue, cancelled
  issueDate     DateTime @default(now())
  dueDate       DateTime?
  subtotal      Float
  taxAmount     Float
  totalAmount   Float
  amountPaid    Float    @default(0)
  balanceDue    Float
  aiGenerated   Boolean  @default(false)
  generatedById String?
  approvedById  String?
  approvedAt    DateTime?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  client      Client        @relation(fields: [clientId], references: [id])
  pet         Pet?          @relation(fields: [petId], references: [id])
  appointment Appointment?  @relation(fields: [appointmentId], references: [id])
  generatedBy User?         @relation("GeneratedBy", fields: [generatedById], references: [id])
  approvedBy  User?         @relation("ApprovedBy", fields: [approvedById], references: [id])
  items       InvoiceItem[]
  payments    Payment[]

  @@index([clientId])
  @@index([invoiceNumber])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id                String  @id @default(uuid())
  invoiceId         String
  itemType          String  // service, product, medication, diagnostic
  description       String
  quantity          Float
  unitPrice         Float
  taxRate           Float   @default(20)
  discountPercentage Float  @default(0)
  subtotal          Float
  total             Float
  inventoryItemId   String?

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model Payment {
  id                  String   @id @default(uuid())
  invoiceId           String
  paymentMethod       String   // cash, card, bank_transfer
  amount              Float
  referenceNumber     String?
  ekasaReceiptNumber  String?
  ekasaOkpCode        String?
  processedById       String?
  notes               String?
  paymentDate         DateTime @default(now())
  createdAt           DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@map("payments")
}

// ============================================
// INVENTORY
// ============================================

model InventoryItem {
  id                  String    @id @default(uuid())
  categoryId          String?
  sku                 String?   @unique
  barcode             String?
  name                String
  description         String?
  manufacturer        String?
  unitOfMeasure       String?
  packageSize         String?
  costPerUnit         Float?
  sellingPrice        Float?
  markupPercentage    Float?
  isPrescription      Boolean   @default(false)
  isControlledSubstance Boolean @default(false)
  requiresRefrigeration Boolean @default(false)
  minimumStock        Int       @default(0)
  optimalStock        Int?
  currentStock        Int       @default(0)
  location            String?
  isSellableInEshop   Boolean   @default(false)
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  batches      InventoryBatch[]
  transactions InventoryTransaction[]

  @@index([sku])
  @@index([name])
  @@map("inventory_items")
}

model InventoryBatch {
  id             String    @id @default(uuid())
  itemId         String
  batchNumber    String
  quantity       Int
  costPerUnit    Float
  expirationDate DateTime?
  supplierId     String?
  receivedDate   DateTime  @default(now())

  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([itemId])
  @@index([expirationDate])
  @@map("inventory_batches")
}

model InventoryTransaction {
  id              String   @id @default(uuid())
  itemId          String
  transactionType String   // purchase, sale, adjustment, damage, expiry
  quantity        Int
  unitCost        Float?
  totalCost       Float?
  referenceType   String?
  referenceId     String?
  performedById   String?
  notes           String?
  createdAt       DateTime @default(now())

  item InventoryItem @relation(fields: [itemId], references: [id])

  @@index([itemId])
  @@index([createdAt])
  @@map("inventory_transactions")
}

// ============================================
// COMMUNICATIONS
// ============================================

model ClientCommunication {
  id                String   @id @default(uuid())
  clientId          String
  communicationType String   // email, sms, call, in_person
  direction         String   // inbound, outbound
  subject           String?
  content           String?
  status            String   @default("draft") // draft, sent, delivered, failed, read
  sentById          String?
  sentAt            DateTime?
  metadata          Json?
  createdAt         DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@map("client_communications")
}

// ============================================
// E-SHOP
// ============================================

model EshopOrder {
  id             String   @id @default(uuid())
  orderNumber    String   @unique
  clientId       String
  status         String   @default("pending")
  subtotal       Float
  shippingFee    Float    @default(0)
  taxAmount      Float
  totalAmount    Float
  paymentMethod  String?
  paymentStatus  String   @default("pending")
  shippingAddress Json?
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  client Client          @relation(fields: [clientId], references: [id])
  items  EshopOrderItem[]

  @@index([clientId])
  @@index([orderNumber])
  @@map("eshop_orders")
}

model EshopOrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  unitPrice Float
  total     Float

  order EshopOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("eshop_order_items")
}

// ============================================
// AUDIT LOGS
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}
